<?xml version="1.0" encoding="utf-8" ?>
<ContentPage  
    x:Class="MarketingAppHJ.Cliente.Views.Aplicacion.MainPage.MainPage"  
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"  
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"  
    xmlns:dtos="clr-namespace:MarketingAppHJ.Aplicacion.Dtos;assembly=MarketingAppHJ.Aplicacion"
    xmlns:vm="clr-namespace:MarketingAppHJ.Cliente.ViewModels.MainPageViewModel"  
    x:DataType="vm:MainPageViewModel"
    Shell.NavBarIsVisible="False"
    
   BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundColorLight}, Dark={StaticResource BackgroundColorDark}}">  


    <!-- 1) Layout principal-->
    <Grid RowDefinitions="Auto,Auto,*,Auto" Padding="0">
        <!-- 1.1) Header con los Iconos-->
        <Grid Grid.Row="0" 
              HeightRequest="60"
              Padding="10"
              ColumnDefinitions="Auto,*,Auto"
              BackgroundColor="{AppThemeBinding Light={StaticResource PrimaryColorLight}, Dark={StaticResource PrimaryColorDark}}">

            <ImageButton Grid.Column="0"
                         Source="iconousuario.png"
                         Background="Transparent"
                         Clicked="OnAvatarClicked"/>

            <ImageButton Grid.Column="1"
                         Source="home.png"
                         Background="Transparent"
                         HorizontalOptions="Center"
                         Clicked="OnLogoClicked"/>

            <ImageButton Grid.Column="2"
                         Source="ruedaajustes.png"
                         Background="Transparent"
                         Clicked="OnSettingsClicked"/>
        </Grid>

        <!-- 1.2) Barra de búsqueda -->
        <Border Grid.Row="1"
                Margin="20,10"
                StrokeShape="RoundRectangle 25"
                BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceColorLight}, Dark={StaticResource SurfaceColorDark}}"
                StrokeThickness="0">
            <Grid ColumnDefinitions="Auto,*">
                <Image Source="lupabusqueda.png"
                       WidthRequest="24"
                       HeightRequest="24"
                       Margin="10,0"
                       VerticalOptions="Center"
                       Opacity="0.6"/>

                <Entry Grid.Column="1"
                       Placeholder="Busca lo que necesites"
                       Margin="0,0,10,0"
                       BackgroundColor="Transparent"
                       VerticalOptions="Center"
                       Text="{Binding TextoBusqueda , Mode=TwoWay}"
                       TextColor="{AppThemeBinding Light={StaticResource TextPrimaryColorLight}, Dark={StaticResource TextPrimaryColorDark}}"
                       ClearButtonVisibility="WhileEditing"/>
            </Grid>
        </Border>

        <!-- 1.3) Grid de productos con paginación infinita -->
        <CollectionView Grid.Row="2"
                        x:Name="ProductosCollectionView"
                        ItemsSource="{Binding Productos}"
                        Margin="10,0"
                        SelectionMode="None"
                        ItemsLayout="VerticalGrid,2"
                        RemainingItemsThreshold="2"
                        RemainingItemsThresholdReached="OnRemainingItemsThresholdReached">

            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="dtos:ProductoDto">
                    <Border Style="{StaticResource CardBorderStyle}">

                        <Grid RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="4">
                            <!-- 1) Imagen -->
                            <Image Source="{Binding ImagenUrl}"
                                   Aspect="AspectFit"
                                   HeightRequest="120" />

                            <!-- 2) Nombre -->
                            <Label Grid.Row="1"
                                   Text="{Binding Nombre}"
                                   Style="{StaticResource SubtitleLabelStyle}"
                                   LineBreakMode="TailTruncation"/>

                            <!-- 3) Descripción -->
                            <Label Grid.Row="2"
                                   Text="{Binding Descripcion}"
                                   Style="{StaticResource BodyLabelStyle}"
                                   FontSize="12"
                                   LineBreakMode="TailTruncation"/>

                            <!-- 4) Precio -->
                            <Label Grid.Row="3"
                                   Text="{Binding Precio, StringFormat='Precio: {0:C}'}"
                                   Style="{StaticResource SubtitleLabelStyle}"
                                   FontSize="16"/>
                        </Grid>

                        <!-- Tocar para ir a detalles -->
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnItemTapped" 
                                                  NumberOfTapsRequired="1" />
                        </Border.GestureRecognizers>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- 1.4) Botón fijo “Accede a tu carrito” (fila 3) -->
        <Border Grid.Row="3"
                StrokeShape="RoundRectangle 20,20,0,0"
                StrokeThickness="1"
                BackgroundColor="{AppThemeBinding Light={StaticResource SurfaceColorLight}, Dark={StaticResource SurfaceColorDark}}"
                Padding="10,0">
            <Button Text="Accede a tu carrito"
                    ImageSource="carritocompra.png"
                    ContentLayout="Left,10"
                    Style="{StaticResource PrimaryButtonStyle}"
                    Clicked="OnCartClicked"/>
        </Border>
    </Grid>
</ContentPage>